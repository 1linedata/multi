<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quảng cáo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .kpi-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            min-height: 350px;
        }
        .loader {
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        .ai-loader {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;}
        .prose p, .prose ul { margin-bottom: 0.75rem; }
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .typing-dot {
            animation: typing-pulse 1.5s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-pulse {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        /* Confirmation popup */
        .confirmation-popup {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        /* Sortable table header */
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .sort-icon {
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        .sortable-header.sorted .sort-icon {
            opacity: 1;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Dashboard Hiệu suất Quảng cáo</h1>
                <p id="lastUpdated" class="text-slate-600 mt-1">Đang tải dữ liệu...</p>
            </div>
            <div class="flex items-center gap-2 mt-4 md:mt-0">
                 <button id="addRecordBtn" class="bg-green-600 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-green-700 transition-colors shadow-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span>Thêm Bản ghi</span>
                </button>
                <button id="refreshDataBtn" class="bg-blue-600 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center justify-center disabled:bg-blue-400 disabled:cursor-wait">
                    <svg id="refreshDataIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5m7 0h5V4M4 20h5v-5m7 0h5v-5" /></svg>
                    <div id="dataLoader" class="loader w-5 h-5 rounded-full border-2 border-slate-200 hidden mr-2"></div>
                    <span>Làm mới Dữ liệu</span>
                </button>
                <button id="refreshAiBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm flex items-center justify-center disabled:bg-indigo-400 disabled:cursor-wait">
                     <svg id="refreshAiIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    <div id="aiLoader" class="loader w-5 h-5 rounded-full border-2 border-slate-200 hidden mr-2"></div>
                    <span>Phân tích AI</span>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="border-b border-slate-200 mb-6">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-chatbot" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Chatbot</button>
                <button id="tab-dashboard" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700">Dashboard</button>
            </nav>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Chatbot View -->
            <div id="view-chatbot">
                <div class="bg-white rounded-lg shadow-sm p-4 flex flex-col" style="height: 65vh;">
                    <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 pr-2 space-y-4">
                         <div class="flex justify-start"><div class="chat-bubble-ai p-3 rounded-lg max-w-lg">Xin chào! Tôi có thể giúp gì cho bạn?</div></div>
                    </div>
                    <div class="flex gap-2 border-t pt-4">
                        <input type="text" id="chat-input" placeholder="Hỏi AI qua webhook..." class="flex-grow w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button id="chat-send-btn" class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm flex items-center justify-center disabled:bg-indigo-400">Gửi</button>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="hidden">
                <!-- AI Analysis -->
                <div id="ai-analysis-container" class="mb-6 bg-white p-6 rounded-lg shadow-sm">
                    <h2 id="ai-title" class="text-xl font-bold text-slate-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        <span>AI Phân tích & Đề xuất</span>
                    </h2>
                     <div id="ai-summary" class="text-slate-700 prose prose-sm max-w-none">
                        <p>Lọc dữ liệu bên dưới và nhấn nút "Phân tích AI" để nhận đề xuất chi tiết.</p>
                    </div>
                </div>

                <!-- KPI Cards & Charts -->
                <div id="dashboard-content">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-center gap-5">
                            <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg></div>
                            <div><p class="text-sm text-slate-500">Tổng chi tiêu</p><p id="kpi-spend" class="text-2xl font-bold">0</p></div>
                        </div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-center gap-5">
                            <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></div>
                            <div><p class="text-sm text-slate-500">Lượt hiển thị</p><p id="kpi-impressions" class="text-2xl font-bold">0</p></div>
                        </div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-center gap-5">
                            <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg></div>
                            <div><p class="text-sm text-slate-500">CPC Trung bình</p><p id="kpi-cpc" class="text-2xl font-bold">0</p></div>
                        </div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-center gap-5">
                            <div class="bg-purple-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg></div>
                            <div><p class="text-sm text-slate-500">Tổng Click</p><p id="kpi-clicks" class="text-2xl font-bold">0</p></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm chart-container flex flex-col">
                            <h3 class="font-semibold mb-4">Hiệu suất theo Nhóm quảng cáo</h3><div class="flex-grow"><canvas id="performanceChart"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm chart-container flex flex-col">
                            <h3 class="font-semibold mb-4">Phân bổ chi tiêu theo Nhóm quảng cáo</h3><div class="flex-grow"><canvas id="campaignSpendChart"></canvas></div>
                        </div>
                    </div>
                    <!-- Data Table -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="font-semibold text-lg">Danh sách Bản ghi</h3>
                            <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
                                 <div class="w-full md:w-48">
                                    <select id="campaignFilter" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div class="flex items-center gap-2 w-full">
                                    <input type="number" id="minSpendFilter" placeholder="Chi tiêu tối thiểu" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <span class="text-slate-500">-</span>
                                    <input type="number" id="maxSpendFilter" placeholder="Chi tiêu tối đa" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="relative w-full md:w-64">
                                    <input type="text" id="searchInput" placeholder="Tìm kiếm nhóm quảng cáo..." class="w-full pl-4 pr-10 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="campaign">Nhóm quảng cáo <span class="sort-icon"></span></th>
                                        <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="spend">Chi tiêu <span class="sort-icon"></span></th>
                                        <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="impressions">Lượt hiển thị <span class="sort-icon"></span></th>
                                        <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="clicks">Clicks <span class="sort-icon"></span></th>
                                        <th scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-sort="cpc">CPC <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700"></div>

        <!-- Add/Edit Record Modal -->
        <div id="addRecordModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div id="modalOverlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
            <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl z-50 overflow-y-auto transform scale-95 opacity-0">
                <div class="p-6">
                    <h3 id="modalTitle" class="text-xl font-semibold mb-4">Thêm Bản ghi mới</h3>
                    <form id="addRecordForm">
                        <input type="hidden" name="originalCampaignName" id="originalCampaignName">
                        <div class="space-y-4">
                            <div>
                                <label for="form-campaign" class="block text-sm font-medium text-slate-700">Tên Nhóm quảng cáo</label>
                                <input type="text" name="Ad Set Name" id="form-campaign" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="form-spend" class="block text-sm font-medium text-slate-700">Số tiền đã chi tiêu</label>
                                <input type="number" step="0.01" name="Amount Spent" id="form-spend" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="form-impressions" class="block text-sm font-medium text-slate-700">Lượt hiển thị</label>
                                <input type="number" name="Impressions" id="form-impressions" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="form-clicks" class="block text-sm font-medium text-slate-700">Lượt nhấp vào liên kết</label>
                                <input type="number" name="Link Clicks" id="form-clicks" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="form-cpc" class="block text-sm font-medium text-slate-700">CPC (Chi phí mỗi lượt nhấp)</label>
                                <input type="number" step="0.01" name="CPC (Cost per Link Click)" id="form-cpc" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button type="button" id="cancelModalBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Hủy</button>
                            <button type="submit" id="submitFormBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center disabled:bg-green-400">
                                <div id="formLoader" class="loader w-4 h-4 rounded-full border-2 border-slate-200 hidden mr-2"></div>
                                Gửi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black bg-opacity-50"></div>
            <div class="bg-white w-11/12 md:max-w-sm mx-auto rounded-lg shadow-xl z-50 p-6">
                <h3 class="text-lg font-bold text-slate-900">Xác nhận Xóa</h3>
                <p class="text-slate-600 mt-2 mb-6">Bạn có chắc chắn muốn xóa bản ghi này không? Hành động này không thể hoàn tác.</p>
                <div class="flex justify-end gap-3">
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Hủy</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center">Xóa</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Popup -->
        <div id="confirmationPopup" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 confirmation-popup">
            Thao tác thành công!
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const GET_DATA_WEBHOOK_URL = 'https://aps.aibm.space/webhook/sheet1';
        const CHAT_WEBHOOK_URL = 'https://aps.aibm.space/webhook/sheet3';
        const MANIPULATE_DATA_WEBHOOK_URL = 'https://aps.aibm.space/webhook/sheet4'; // For Add, Edit, Delete
        const GEMINI_API_KEY = 'AIzaSyCwDScu9CH21vg4QUTvSkA3oIERB-jj7Sg';

        // --- DOM ELEMENTS ---
        const lastUpdated = document.getElementById('lastUpdated');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const refreshAiBtn = document.getElementById('refreshAiBtn');
        const errorMessage = document.getElementById('error-message');
        const aiAnalysisContainer = document.getElementById('ai-analysis-container');
        const aiSummaryDiv = document.getElementById('ai-summary');
        const aiTitle = document.getElementById('ai-title');
        const dataLoader = document.getElementById('dataLoader');
        const aiLoader = document.getElementById('aiLoader');
        const refreshDataIcon = document.getElementById('refreshDataIcon');
        const refreshAiIcon = document.getElementById('refreshAiIcon');
        
        const kpiSpend = document.getElementById('kpi-spend');
        const kpiImpressions = document.getElementById('kpi-impressions');
        const kpiCpc = document.getElementById('kpi-cpc');
        const kpiClicks = document.getElementById('kpi-clicks');
        
        const tabDashboard = document.getElementById('tab-dashboard');
        const tabChatbot = document.getElementById('tab-chatbot');
        const viewDashboard = document.getElementById('view-dashboard');
        const viewChatbot = document.getElementById('view-chatbot');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        
        const addRecordBtn = document.getElementById('addRecordBtn');
        const addRecordModal = document.getElementById('addRecordModal');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalContainer = addRecordModal.querySelector('.modal-container');
        const modalTitle = document.getElementById('modalTitle');
        const addRecordForm = document.getElementById('addRecordForm');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const submitFormBtn = document.getElementById('submitFormBtn');
        const formLoader = document.getElementById('formLoader');
        const dataTableBody = document.getElementById('dataTableBody');
        const confirmationPopup = document.getElementById('confirmationPopup');
        const searchInput = document.getElementById('searchInput');
        const minSpendFilter = document.getElementById('minSpendFilter');
        const maxSpendFilter = document.getElementById('maxSpendFilter');
        const campaignFilter = document.getElementById('campaignFilter');


        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // --- STATE ---
        let allData = [];
        let displayedData = [];
        let charts = {};
        let isProcessing = false;
        let currentRecordForEdit = null;
        let recordToDelete = null;
        let sortConfig = { key: 'campaign', direction: 'ascending' };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            loadDataFromWebhook();
            addEventListeners();
        });
        
        function addEventListeners() {
            refreshDataBtn.addEventListener('click', loadDataFromWebhook);
            refreshAiBtn.addEventListener('click', handleAiRefresh);
            searchInput.addEventListener('input', applyFiltersAndSorting);
            minSpendFilter.addEventListener('input', applyFiltersAndSorting);
            maxSpendFilter.addEventListener('input', applyFiltersAndSorting);
            campaignFilter.addEventListener('change', applyFiltersAndSorting);
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (sortConfig.key === sortKey) {
                        sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
                    } else {
                        sortConfig.key = sortKey;
                        sortConfig.direction = 'ascending';
                    }
                    applyFiltersAndSorting();
                });
            });
            
            tabDashboard.addEventListener('click', () => switchView('dashboard'));
            tabChatbot.addEventListener('click', () => switchView('chatbot'));

            chatSendBtn.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleChatSubmit();
            });

            addRecordBtn.addEventListener('click', handleAddClick);
            cancelModalBtn.addEventListener('click', hideAddEditModal);
            modalOverlay.addEventListener('click', hideAddEditModal);
            addRecordForm.addEventListener('submit', handleFormSubmit);

            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            confirmDeleteBtn.addEventListener('click', processDelete);
        }

        function switchView(viewName) {
            if (viewName === 'dashboard') {
                viewDashboard.classList.remove('hidden');
                viewChatbot.classList.add('hidden');
                tabDashboard.classList.add('active');
                tabChatbot.classList.remove('active');
            } else {
                viewDashboard.classList.add('hidden');
                viewChatbot.classList.remove('hidden');
                tabDashboard.classList.remove('active');
                tabChatbot.classList.add('active');
            }
        }

        function applyFiltersAndSorting() {
            let filteredData = [...allData];

            // Dropdown filter
            const selectedCampaign = campaignFilter.value;
            if (selectedCampaign !== 'all') {
                filteredData = filteredData.filter(d => d.campaign === selectedCampaign);
            }

            // Search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredData = filteredData.filter(d => 
                    d.campaign.toLowerCase().includes(searchTerm)
                );
            }

            // Spend range filter
            const minSpend = parseFloat(minSpendFilter.value);
            const maxSpend = parseFloat(maxSpendFilter.value);

            if (!isNaN(minSpend)) {
                filteredData = filteredData.filter(d => d.spend >= minSpend);
            }
            if (!isNaN(maxSpend)) {
                filteredData = filteredData.filter(d => d.spend <= maxSpend);
            }
            
            // Sorting
            filteredData.sort((a, b) => {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];
                
                let comparison = 0;
                if (aValue > bValue) {
                    comparison = 1;
                } else if (aValue < bValue) {
                    comparison = -1;
                }
                
                return sortConfig.direction === 'descending' ? comparison * -1 : comparison;
            });

            displayedData = filteredData;
            updateDashboardUI(displayedData);
        }
        
        async function loadDataFromWebhook() {
            if (isProcessing) return;
            setLoadingState(true, 'data');
            hideError();
            
            try {
                const response = await fetch(GET_DATA_WEBHOOK_URL, { method: 'POST' });
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}`);
                
                const responseData = await response.json();
                const dataArray = responseData[0]?.json ? responseData.map(item => item.json) : responseData;

                if (!Array.isArray(dataArray)) {
                     throw new Error("Webhook không trả về dữ liệu hoặc định dạng không đúng.");
                }

                processAndStoreData(dataArray);
                applyFiltersAndSorting();
                
                const now = new Date();
                lastUpdated.textContent = `Cập nhật lần cuối lúc: ${now.toLocaleTimeString('vi-VN')}`;

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Webhook:", error);
                showError(error.message);
            } finally {
                setLoadingState(false, 'data');
            }
        }
        
        function initializeCharts() {
            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#64748b' } },
                    y: { grid: { color: '#e2e8f0' }, ticks: { color: '#64748b' } }
                }
            };
            charts.performance = new Chart(document.getElementById('performanceChart'), {
                type: 'bar', data: { labels: [], datasets: [] },
                options: { ...defaultOptions,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { stacked: true },
                        y1: { type: 'linear', position: 'left', title: { display: true, text: 'Chi tiêu' }, stacked: true },
                        y2: { type: 'linear', position: 'right', title: { display: true, text: 'Lượt hiển thị' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
            charts.campaignSpend = new Chart(document.getElementById('campaignSpendChart'), {
                type: 'doughnut', data: { labels: [], datasets: [] },
                options: { ...defaultOptions, scales: {} }
            });
        }
        
        function processAndStoreData(dataArray) {
             const processed = dataArray.map((item, index) => ({
                row_number: index + 2, // Assuming data starts at row 2 in the sheet
                campaign: item['Ad Set Name'],
                spend: parseFloat(item['Amount Spent'] || 0),
                impressions: parseInt(item['Impressions'] || 0, 10),
                clicks: parseInt(item['Link Clicks'] || 0, 10),
                cpc: parseFloat(item['CPC (Cost per Link Click)'] || 0)
            })).filter(item => item.campaign);
            
            allData = processed;
            
            // Populate campaign dropdown
            const campaigns = [...new Set(allData.map(d => d.campaign))];
            campaignFilter.innerHTML = '<option value="all">Tất cả Nhóm quảng cáo</option>';
            campaigns.forEach(c => {
                const option = document.createElement('option');
                option.value = c; option.textContent = c;
                campaignFilter.appendChild(option);
            });
        }

        function updateDashboardUI(data) {
            updateKPIs(data);
            updatePerformanceChart(data);
            updateCampaignSpendChart(data);
            updateDataTable(data);
            updateSortIcons();
        }

        function updateKPIs(data) {
            const totals = data.reduce((acc, item) => {
                acc.spend += item.spend;
                acc.impressions += item.impressions;
                acc.clicks += item.clicks;
                return acc;
            }, { spend: 0, impressions: 0, clicks: 0 });

            const avgCpc = totals.clicks > 0 ? totals.spend / totals.clicks : 0;
            const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 2 });
            const numberFormatter = new Intl.NumberFormat('en-US');

            kpiSpend.textContent = currencyFormatter.format(totals.spend);
            kpiImpressions.textContent = numberFormatter.format(totals.impressions);
            kpiCpc.textContent = currencyFormatter.format(avgCpc);
            kpiClicks.textContent = numberFormatter.format(totals.clicks);
        }

        function updatePerformanceChart(data) {
            const performanceByCampaign = data.reduce((acc, item) => {
                if (!acc[item.campaign]) acc[item.campaign] = { spend: 0, impressions: 0 };
                acc[item.campaign].spend += item.spend;
                acc[item.campaign].impressions += item.impressions;
                return acc;
            }, {});

            const labels = Object.keys(performanceByCampaign);
            charts.performance.data.labels = labels;
            charts.performance.data.datasets = [
                { label: 'Chi tiêu', data: labels.map(l => performanceByCampaign[l].spend), backgroundColor: '#3b82f6', yAxisID: 'y1' },
                { label: 'Lượt hiển thị', data: labels.map(l => performanceByCampaign[l].impressions), backgroundColor: '#16a34a', yAxisID: 'y2', type: 'line', tension: 0.2 }
            ];
            charts.performance.update();
        }

        function updateCampaignSpendChart(data) {
            const spendByCampaign = data.reduce((acc, item) => {
                if (!acc[item.campaign]) acc[item.campaign] = 0;
                acc[item.campaign] += item.spend;
                return acc;
            }, {});

            const labels = Object.keys(spendByCampaign);
            const spendData = Object.values(spendByCampaign);
            charts.campaignSpend.data.labels = labels;
            charts.campaignSpend.data.datasets = [{
                label: 'Chi tiêu', data: spendData,
                backgroundColor: ['#3b82f6', '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b101', '#06b6d4', '#8b5cf6', '#d946ef']
            }];
            charts.campaignSpend.update();
        }

        function updateDataTable(data) {
            dataTableBody.innerHTML = '';
            
            if (data.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 py-4">Không có dữ liệu phù hợp.</td></tr>`;
                return;
            }
            
            const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'decimal', maximumFractionDigits: 2 });
            const numberFormatter = new Intl.NumberFormat('en-US');

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.campaign}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${currencyFormatter.format(item.spend)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${numberFormatter.format(item.impressions)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${numberFormatter.format(item.clicks)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${currencyFormatter.format(item.cpc)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Sửa</button>
                        <button class="delete-btn text-red-600 hover:text-red-900">Xóa</button>
                    </td>
                `;
                row.querySelector('.edit-btn').addEventListener('click', () => handleEditClick(item));
                row.querySelector('.delete-btn').addEventListener('click', () => handleDeleteClick(item));
                dataTableBody.appendChild(row);
            });
        }
        
        function updateSortIcons() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (header.dataset.sort === sortConfig.key) {
                    header.classList.add('sorted');
                    icon.innerHTML = sortConfig.direction === 'ascending' ? '▲' : '▼';
                } else {
                    header.classList.remove('sorted');
                    icon.innerHTML = '';
                }
            });
        }

        function handleAiRefresh() {
            if (isProcessing) return;
            // Use the currently displayed data for analysis
            if (displayedData.length > 0) {
                getAiSummary(displayedData);
            } else {
                aiSummaryDiv.innerHTML = `<p>Không có dữ liệu để phân tích. Vui lòng điều chỉnh bộ lọc.</p>`;
            }
        }

        async function getAiSummary(data) {
            setLoadingState(true, 'ai');
            aiAnalysisContainer.classList.remove('hidden');
            aiSummaryDiv.innerHTML = `<div class="flex items-center"><div class="ai-loader w-5 h-5 rounded-full border-2 mr-3"></div><span>AI đang phân tích dữ liệu...</span></div>`;
            
            let analysisScope = "cho tập dữ liệu hiện tại";
            if (data.length < allData.length) {
                analysisScope = "cho tập dữ liệu đã được lọc";
            }

            const totals = data.reduce((acc, item) => ({
                spend: acc.spend + item.spend,
                impressions: acc.impressions + item.impressions,
                clicks: acc.clicks + item.clicks,
            }), { spend: 0, impressions: 0, clicks: 0 });
            const avgCpc = totals.clicks > 0 ? totals.spend / totals.clicks : 0;

            const prompt = `Assume the role of a marketing data analyst. Based on the following summary from an ad campaign report ${analysisScope}, provide a concise summary and 3 actionable recommendations to optimize performance.
            - Total Records Analyzed: ${data.length}
            - Total Spend: ${totals.spend.toFixed(2)}
            - Total Impressions: ${totals.impressions}
            - Total Clicks: ${totals.clicks}
            - Average CPC: ${avgCpc.toFixed(2)}
            Present the answer in Vietnamese using Markdown, with clear headings and bullet points.`;
            
            try {
                const response = await callGeminiApi(prompt);
                aiSummaryDiv.innerHTML = marked.parse(response);
            } catch (error) {
                console.error("Lỗi khi gọi AI API:", error);
                aiSummaryDiv.innerHTML = `<p class="text-red-600"><strong>Lỗi:</strong> ${error.message}</p>`;
            } finally {
                setLoadingState(false, 'ai');
            }
        }

        async function handleChatSubmit() {
            const userInput = chatInput.value.trim();
            if (!userInput || isProcessing) return;
            
            setLoadingState(true, 'chat');
            appendChatMessage(userInput, 'user');
            chatInput.value = '';
            showTypingIndicator(true);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 phút timeout

            try {
                const response = await fetch(CHAT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "prompt": userInput }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`Lỗi từ webhook: ${response.status} ${response.statusText}`);

                const result = await response.json();
                let aiResponse;
                if (Array.isArray(result) && result.length > 0 && result[0].output) {
                    aiResponse = result[0].output;
                } else if (result.output) {
                    aiResponse = result.output;
                } else {
                    aiResponse = `Phản hồi từ webhook không có trường "output": ${JSON.stringify(result)}`;
                }
                appendChatMessage(aiResponse, 'ai');
            } catch (error) {
                if (error.name === 'AbortError') {
                    appendChatMessage('Xin lỗi, yêu cầu đã hết thời gian chờ sau 10 phút. Vui lòng thử lại.', 'ai');
                } else {
                    appendChatMessage(`Xin lỗi, tôi gặp lỗi khi xử lý câu hỏi của bạn: ${error.message}`, 'ai');
                }
            } finally {
                showTypingIndicator(false);
                setLoadingState(false, 'chat');
            }
        }
        
        function showTypingIndicator(show) {
            let indicator = document.getElementById('typing-indicator');
            if (show) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'flex justify-start';
                    indicator.innerHTML = `<div class="chat-bubble-ai p-3 rounded-lg max-w-lg flex items-center space-x-1">
                        <div class="typing-dot w-2 h-2 bg-slate-500 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-slate-500 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-slate-500 rounded-full"></div>
                    </div>`;
                    chatMessages.appendChild(indicator);
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                if (indicator) indicator.remove();
            }
        }

        function appendChatMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-lg max-w-lg ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            messageBubble.innerHTML = marked.parse(message);
            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function callGeminiApi(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("Gemini API HTTP Error:", response.status, errorBody);
                throw new Error(`Yêu cầu đến AI thất bại (mã lỗi ${response.status}).`);
            }
            
            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) return text;
            else {
                console.error("Gemini API Response missing text:", JSON.stringify(result));
                throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
            }
        }

        // --- Add/Edit/Delete Record Functions ---
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        function showAddEditModal() {
            addRecordModal.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContainer.classList.remove('scale-95', 'opacity-0');
                modalContainer.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideAddEditModal() {
            modalOverlay.classList.add('opacity-0');
            modalContainer.classList.add('scale-95', 'opacity-0');
            modalContainer.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                addRecordModal.classList.add('hidden');
                addRecordForm.reset();
                currentRecordForEdit = null;
            }, 300);
        }

        function handleAddClick() {
            currentRecordForEdit = null;
            modalTitle.textContent = 'Thêm Bản ghi mới';
            addRecordForm.reset();
            showAddEditModal();
        }

        function handleEditClick(record) {
            currentRecordForEdit = record;
            modalTitle.textContent = 'Chỉnh sửa Bản ghi';
            document.getElementById('originalCampaignName').value = record.campaign;
            document.getElementById('form-campaign').value = record.campaign;
            document.getElementById('form-spend').value = record.spend;
            document.getElementById('form-impressions').value = record.impressions;
            document.getElementById('form-clicks').value = record.clicks;
            document.getElementById('form-cpc').value = record.cpc;
            showAddEditModal();
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            submitFormBtn.disabled = true;
            formLoader.classList.remove('hidden');

            const formData = new FormData(addRecordForm);
            const dataObject = Object.fromEntries(formData.entries());
            
            let prompt;
            const task = currentRecordForEdit ? 'edit1' : 'addrecord1';

            if (task === 'edit1') {
                const originalName = dataObject.originalCampaignName;
                delete dataObject.originalCampaignName; // Remove helper field before sending
                const updateDataString = Object.entries(dataObject).map(([key, value]) => `"${key}": "${value}"`).join(', ');
                prompt = `task: edit1 - matchOn: {"Ad Set Name": "${originalName}"} - data: {${updateDataString}}`;
            } else {
                const dataString = Object.entries(dataObject).map(([key, value]) => `"${key}": "${value}"`).join(', ');
                prompt = `task: addrecord1 - {${dataString}}`;
            }

            try {
                const response = await fetch(MANIPULATE_DATA_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    throw new Error(`Lỗi khi gửi dữ liệu: ${response.statusText}`);
                }
                
                await sleep(2000);
                await loadDataFromWebhook();

                hideAddEditModal();
                showConfirmationPopup();

            } catch (error) {
                console.error("Lỗi khi thêm/sửa bản ghi:", error);
                showError(error.message);
            } finally {
                submitFormBtn.disabled = false;
                formLoader.classList.add('hidden');
            }
        }
        
        function handleDeleteClick(record) {
            recordToDelete = record;
            deleteConfirmModal.classList.remove('hidden');
        }

        function hideDeleteModal() {
            recordToDelete = null;
            deleteConfirmModal.classList.add('hidden');
        }

        async function processDelete() {
            if (!recordToDelete) return;
            
            const prompt = `task: delete1 - row_number: ${recordToDelete.row_number}`;

            try {
                const response = await fetch(MANIPULATE_DATA_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    throw new Error(`Lỗi khi xóa bản ghi: ${response.statusText}`);
                }

                await sleep(2000);
                await loadDataFromWebhook();
                
                showConfirmationPopup();

            } catch (error) {
                console.error("Lỗi khi xóa bản ghi:", error);
                showError(error.message);
            } finally {
                hideDeleteModal();
            }
        }

        function showConfirmationPopup() {
            confirmationPopup.textContent = 'Thao tác thành công!';
            confirmationPopup.classList.remove('bg-red-500');
            confirmationPopup.classList.add('bg-green-500');
            confirmationPopup.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                confirmationPopup.classList.add('translate-y-20', 'opacity-0');
            }, 3000); // Hide after 3 seconds
        }

        function setLoadingState(isLoading, type) {
            isProcessing = isLoading;
            refreshDataBtn.disabled = isLoading;
            refreshAiBtn.disabled = isLoading;
            chatSendBtn.disabled = isLoading;
            chatInput.disabled = isLoading;

            if (type === 'data') {
                dataLoader.classList.toggle('hidden', !isLoading);
                refreshDataIcon.classList.toggle('hidden', isLoading);
            } else if (type === 'ai') {
                aiLoader.classList.toggle('hidden', !isLoading);
                refreshAiIcon.classList.toggle('hidden', isLoading);
            }
        }

        function showError(msg) {
            errorMessage.textContent = `Lỗi: ${msg}`;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

    </script>
</body>
</html>
