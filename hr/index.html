<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng điều khiển AI cho Nhân sự</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .nav-tab { cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .nav-tab.active { background-color: #3b82f6; color: white; border-bottom-color: transparent; }
        .nav-tab:not(.active):hover { background-color: #374151; }
        .ai-insight-card { background-color: #262c40; border-left: 4px solid #4f46e5; }
        .kanban-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .kanban-column { min-width: 300px; width: 300px; background-color: #111827; border-radius: 0.75rem; padding: 0.75rem; }
        .kanban-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: background-color 0.2s; }
        .kanban-card:hover { background-color: #374151; }
        .kanban-card.dragging { opacity: 0.5; cursor: grabbing; }
        .kanban-column .drag-over { background-color: #374151; }
        .loader { width: 1rem; height: 1rem; border: 2px solid #e5e7eb; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 600px; z-index: 50; position: relative; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; cursor: pointer; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-full mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Bảng điều khiển AI Nhân sự</h1>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 flex justify-center border-b border-gray-700">
            <div id="tab-dashboard" class="nav-tab active text-lg font-semibold px-6 py-3 rounded-t-lg">Dashboard</div>
            <div id="tab-recruitment" class="nav-tab text-lg font-semibold px-6 py-3 rounded-t-lg">Quy trình Tuyển dụng</div>
            <div id="tab-payroll" class="nav-tab text-lg font-semibold px-6 py-3 rounded-t-lg">Quy trình Lương</div>
        </div>

        <!-- Page Content -->
        <div id="page-content">
            <div id="page-dashboard">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="total-applicants-card" class="card p-6 rounded-xl shadow-lg"></div>
                    <div id="interview-applicants-card" class="card p-6 rounded-xl shadow-lg"></div>
                    <div id="total-employees-card" class="card p-6 rounded-xl shadow-lg"></div>
                    <div id="total-payroll-card" class="card p-6 rounded-xl shadow-lg"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                    <div class="lg:col-span-3 card p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold mb-4 text-white">Nhân sự theo Phòng ban</h2><canvas id="employeesByDeptChart"></canvas></div>
                    <div class="lg:col-span-2 card p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold mb-4 text-white">Phễu Tuyển dụng</h2><canvas id="recruitmentFunnelChart"></canvas></div>
                </div>
                <div class="card p-6 rounded-xl shadow-lg ai-insight-card"><h2 class="text-xl font-semibold mb-3 text-white flex items-center gap-2">Phân tích nhanh từ AI</h2><div id="dashboard-ai-insight" class="text-lg text-indigo-200">Đang phân tích...</div></div>
            </div>
            <div id="page-recruitment" class="hidden"><div id="recruitment-kanban-view"></div></div>
            <div id="page-payroll" class="hidden"><div id="payroll-kanban-view"></div></div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <script>
        // --- DATA (Normally from an API) ---
        const applicantsCsvData = `Tên,Vị trí,Trạng thái,Ngày nộp
Lê Thị Duyên,Marketing Executive,Phỏng vấn V1,2025-08-02
Phạm Văn Em,Sales Manager,Chờ phản hồi,2025-07-29
Hoàng Anh F,Marketing Executive,Từ chối,2025-07-25
Nguyễn Thị G,Data Analyst,Đã nhận việc,2025-07-22
Trần Văn H,IT Support,Phỏng vấn V2,2025-08-01
Mai Anh I,Marketing Executive,Phỏng vấn V1,2025-08-03
Vũ Đức K,Sales Executive,Từ chối,2025-07-28`;

        const employeesCsvData = `Mã NV,Tên,Phòng ban,Lương,Trạng thái TT
NV001,Trần Vân Anh,Sales,25000000,Đã trả
NV002,Nguyễn Minh Tú,Sales,22000000,Đã trả
NV003,Lê Hoàng,Marketing,18000000,Đã trả
NV004,Phạm Thị Bích,Marketing,20000000,Sẵn sàng chi
NV005,Võ Thành Danh,IT,35000000,Đã trả
NV006,Đỗ Gia Huy,IT,32000000,Chờ duyệt
NV007,Hoàng Nam,Sales,23000000,Chờ duyệt`;

        let applicantsData = [];
        let employeesData = [];
        let charts = {};

        // --- UTILITY FUNCTIONS ---
        function parseCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const entry = {};
                headers.forEach((header, index) => { entry[header] = values[index]; });
                return entry;
            });
        }
        function formatCurrency(number) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number); }
        function switchTab(tabName) {
            ['dashboard', 'recruitment', 'payroll'].forEach(page => {
                document.getElementById(`page-${page}`).classList.add('hidden');
                document.getElementById(`tab-${page}`).classList.remove('active');
            });
            document.getElementById(`page-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'dashboard') { renderDashboardCharts(); }
        }

        // --- AI & API FUNCTIONS ---
        async function askAI(prompt, context) {
            const promptWrapper = `Bạn là một trợ lý AI phân tích dữ liệu nhân sự. Hãy trả lời ngắn gọn, chính xác bằng tiếng Việt. Context: ${context}. Nhiệm vụ: "${prompt}"`;
            const apiKey = ""; // Leave empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: promptWrapper }] }] };
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
                    }
                    if (response.status >= 400 && response.status < 500) { console.error("AI API client error:", response.status, await response.text()); return "Yêu cầu đến AI không hợp lệ."; }
                } catch (error) { console.error(`AI API call attempt ${i + 1} failed:`, error); }
                if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** i)));
            }
            return "Lỗi kết nối đến AI. Vui lòng thử lại sau.";
        }

        // --- DASHBOARD FUNCTIONS ---
        function renderDashboard() {
            const totalApplicants = applicantsData.length;
            const interviewApplicants = applicantsData.filter(a => a['Trạng thái'].toLowerCase().includes('phỏng vấn')).length;
            const totalEmployees = employeesData.length;
            const totalPayroll = employeesData.reduce((sum, emp) => sum + parseInt(emp['Lương'] || 0, 10), 0);
            document.getElementById('total-applicants-card').innerHTML = `<p class="text-sm font-medium text-gray-400">Tổng Ứng viên</p><p class="text-2xl font-bold text-white mt-1">${totalApplicants}</p>`;
            document.getElementById('interview-applicants-card').innerHTML = `<p class="text-sm font-medium text-gray-400">Đang Phỏng vấn</p><p class="text-2xl font-bold text-white mt-1">${interviewApplicants}</p>`;
            document.getElementById('total-employees-card').innerHTML = `<p class="text-sm font-medium text-gray-400">Tổng Nhân viên</p><p class="text-2xl font-bold text-white mt-1">${totalEmployees}</p>`;
            document.getElementById('total-payroll-card').innerHTML = `<p class="text-sm font-medium text-gray-400">Tổng Quỹ lương</p><p class="text-2xl font-bold text-white mt-1">${formatCurrency(totalPayroll)}</p>`;
            renderDashboardCharts();
            generateDashboardAIInsight();
        }
        function renderDashboardCharts() {
            const deptData = employeesData.reduce((acc, emp) => { acc[emp['Phòng ban']] = (acc[emp['Phòng ban']] || 0) + 1; return acc; }, {});
            const deptCtx = document.getElementById('employeesByDeptChart').getContext('2d');
            if (charts.dept) charts.dept.destroy();
            charts.dept = new Chart(deptCtx, { type: 'bar', data: { labels: Object.keys(deptData), datasets: [{ label: 'Số lượng nhân viên', data: Object.values(deptData), backgroundColor: 'rgba(59, 130, 246, 0.7)' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } } } });
            const funnelData = applicantsData.reduce((acc, app) => { acc[app['Trạng thái']] = (acc[app['Trạng thái']] || 0) + 1; return acc; }, {});
            const funnelCtx = document.getElementById('recruitmentFunnelChart').getContext('2d');
            if (charts.funnel) charts.funnel.destroy();
            charts.funnel = new Chart(funnelCtx, { type: 'pie', data: { labels: Object.keys(funnelData), datasets: [{ data: Object.values(funnelData), backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'] }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#9ca3af' } } } } });
        }
        async function generateDashboardAIInsight() {
            const insightContainer = document.getElementById('dashboard-ai-insight');
            const prompt = `Dựa vào dữ liệu ứng viên và nhân viên, hãy đưa ra một nhận xét hoặc một phát hiện thú vị, ngắn gọn trong một câu bằng tiếng Việt.\n\nỨng viên:\n${applicantsCsvData}\n\nNhân viên:\n${employeesCsvData}`;
            insightContainer.textContent = await askAI(prompt, 'dashboard_insight');
        }

        // --- MODAL FUNCTIONS ---
        function showDetailModal(item, type) {
            const modal = document.getElementById('detail-modal');
            const modalContent = document.getElementById('modal-content');
            let contentHtml = '';

            if (type === 'applicant') {
                contentHtml = `
                    <h3 class="text-2xl font-bold text-white mb-1">${item['Tên']}</h3>
                    <p class="text-lg text-gray-300 mb-4">${item['Vị trí']}</p>
                    <div class="border-t border-gray-700 pt-4 space-y-2">
                        <p class="text-gray-400">Trạng thái: <span class="font-semibold text-white">${item['Trạng thái']}</span></p>
                        <p class="text-gray-400">Ngày nộp đơn: <span class="font-semibold text-white">${item['Ngày nộp']}</span></p>
                    </div>
                    <div id="modal-ai-insight" class="mt-4 p-4 rounded-lg ai-insight-card">
                        <p class="font-semibold text-indigo-300">AI Đánh giá nhanh:</p>
                        <p class="text-indigo-200 italic">Đang phân tích...</p>
                    </div>
                `;
            } else if (type === 'employee') {
                contentHtml = `
                    <h3 class="text-2xl font-bold text-white mb-1">${item['Tên']} (${item['Mã NV']})</h3>
                    <p class="text-lg text-gray-300 mb-4">${item['Phòng ban']}</p>
                    <div class="border-t border-gray-700 pt-4 space-y-2">
                        <p class="text-gray-400">Lương: <span class="font-semibold text-white">${formatCurrency(item['Lương'])}</span></p>
                        <p class="text-gray-400">Trạng thái thanh toán: <span class="font-semibold text-white">${item['Trạng thái TT']}</span></p>
                    </div>
                     <div id="modal-ai-insight" class="mt-4 p-4 rounded-lg ai-insight-card">
                        <p class="font-semibold text-indigo-300">AI Ghi chú:</p>
                        <p class="text-indigo-200 italic">Đang tạo ghi chú...</p>
                    </div>
                `;
            }

            modalContent.innerHTML = contentHtml + `<div class="modal-close-btn" onclick="closeDetailModal()"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></div>`;
            modal.classList.remove('hidden');

            // Fetch AI insight for the modal
            const aiPrompt = `Dựa vào dữ liệu của record sau đây, hãy viết một câu tóm tắt/nhận xét bằng tiếng Việt: ${JSON.stringify(item)}`;
            const context = type === 'applicant' ? 'recruitment_detail' : 'payroll_detail';
            askAI(aiPrompt, context).then(insight => {
                const insightContainer = document.querySelector('#modal-ai-insight p:last-child');
                if (insightContainer) insightContainer.textContent = insight;
            });
        }
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }

        // --- KANBAN FUNCTIONS ---
        function renderKanban(containerId, data, stages, groupByField, cardRenderer, detailType) {
            const container = document.getElementById(containerId);
            let boardHtml = '<div class="kanban-board">';
            stages.forEach(stage => {
                boardHtml += `<div class="kanban-column" data-stage="${stage}"><h3 class="font-semibold text-white mb-4">${stage} (${data.filter(i => i[groupByField] === stage).length})</h3><div class="kanban-cards-container space-y-3 min-h-[100px]">`;
                const itemsInStage = data.filter(item => item[groupByField] === stage);
                itemsInStage.forEach((item) => {
                    const originalIndex = data.findIndex(d => d === item);
                    boardHtml += cardRenderer(item, originalIndex);
                });
                boardHtml += `</div></div>`;
            });
            boardHtml += '</div>';
            container.innerHTML = boardHtml;
            
            // Add event listeners after rendering
            const cards = document.querySelectorAll(`#${containerId} .kanban-card`);
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    const itemIndex = card.dataset.id;
                    showDetailModal(data[itemIndex], detailType);
                });
            });

            setupDragAndDrop(containerId, data, groupByField, () => renderKanban(containerId, data, stages, groupByField, cardRenderer, detailType));
        }

        function setupDragAndDrop(containerId, data, groupByField, rerenderFn) {
            const cards = document.querySelectorAll(`#${containerId} .kanban-card`);
            cards.forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.id);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });

            const columns = document.querySelectorAll(`#${containerId} .kanban-column`);
            columns.forEach(column => {
                column.addEventListener('dragover', e => { e.preventDefault(); column.classList.add('drag-over'); });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    column.classList.remove('drag-over');
                    const cardId = e.dataTransfer.getData('text/plain');
                    const newStage = column.dataset.stage;
                    data[cardId][groupByField] = newStage;
                    rerenderFn();
                });
            });
        }

        function renderRecruitmentKanban() {
            const stages = ["Chờ phản hồi", "Phỏng vấn V1", "Phỏng vấn V2", "Đã nhận việc", "Từ chối"];
            const cardRenderer = (item, index) => `<div class="kanban-card" data-id="${index}"><p class="font-semibold">${item['Tên']}</p><p class="text-sm text-gray-400">${item['Vị trí']}</p></div>`;
            renderKanban('recruitment-kanban-view', applicantsData, stages, 'Trạng thái', cardRenderer, 'applicant');
        }
        
        function renderPayrollKanban() {
            const stages = ["Chờ chấm công", "Chờ duyệt", "Sẵn sàng chi", "Đã trả"];
            const cardRenderer = (item, index) => `<div class="kanban-card" data-id="${index}"><p class="font-semibold">${item['Tên']} (${item['Mã NV']})</p><p class="text-sm text-gray-400">${item['Phòng ban']}</p><p class="text-sm font-bold mt-2">${formatCurrency(item['Lương'])}</p></div>`;
            renderKanban('payroll-kanban-view', employeesData, stages, 'Trạng thái TT', cardRenderer, 'employee');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            applicantsData = parseCsv(applicantsCsvData);
            employeesData = parseCsv(employeesCsvData);
            document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('dashboard'));
            document.getElementById('tab-recruitment').addEventListener('click', () => switchTab('recruitment'));
            document.getElementById('tab-payroll').addEventListener('click', () => switchTab('payroll'));
            document.getElementById('detail-modal').addEventListener('click', (e) => { if(e.target.id === 'detail-modal') closeDetailModal(); });
            renderDashboard();
            renderRecruitmentKanban();
            renderPayrollKanban();
            switchTab('dashboard');
        });
    </script>
</body>
</html>
