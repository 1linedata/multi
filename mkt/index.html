<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marketing Suite - Planner & Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .generated-image, .existing-image { width: 100%; height: 200px; object-fit: cover; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="w-full h-screen flex flex-col">
        <!-- Header and Navigation -->
        <header class="bg-white shadow-md w-full z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-rocket text-3xl text-blue-600"></i>
                        <h1 class="text-xl font-bold ml-3 text-gray-800">AI Marketing Suite</h1>
                    </div>
                    <nav class="flex items-center space-x-2 sm:space-x-4">
                        <button data-view="planner" class="nav-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-sm hover:bg-blue-700 transition">
                            <i class="fas fa-lightbulb mr-2"></i>Kế hoạch
                        </button>
                        <button data-view="calendar" class="nav-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">
                            <i class="fas fa-calendar-days mr-2"></i>Lịch đăng
                        </button>
                    </nav>
                </div>
                 <div class="text-xs text-gray-400 pb-2">UserID: <span id="user-id-display">Đang tải...</span></div>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto">
            <!-- Planner View -->
            <div id="planner-view" class="view active p-4 sm:p-6 lg:p-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left: Create/List Plans -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Tạo Kế Hoạch Mới</h2>
                        <form id="plan-form" class="space-y-4">
                            <input type="text" id="plan-name" placeholder="Tên kế hoạch (VD: Ra mắt BST Hè 2024)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                            <textarea id="plan-keywords" placeholder="Chủ đề / Từ khóa chính (VD: áo polo, vải thoáng mát, thời trang nam)" class="w-full p-3 border border-gray-300 rounded-lg h-24" required></textarea>
                            <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition">
                                <i class="fas fa-plus mr-2"></i>Tạo Kế Hoạch
                            </button>
                        </form>
                        <hr class="my-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">Danh sách Kế hoạch</h3>
                        <div id="plan-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500">Chưa có kế hoạch nào.</p>
                        </div>
                    </div>
                    <!-- Right: Plan Details -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <div id="plan-detail-view">
                            <div class="text-center text-gray-500 py-20">
                                <i class="fas fa-hand-pointer text-5xl mb-4"></i>
                                <h3 class="text-2xl font-bold">Chọn một kế hoạch</h3>
                                <p>để xem chi tiết và tạo bài đăng bằng AI.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="view p-4 sm:p-6 lg:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Lịch Đăng Bài</h2>
                    <button id="show-post-modal-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i>Tạo Bài Đăng Lẻ
                    </button>
                </div>
                <div id="post-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <p class="text-gray-500 md:col-span-2 xl:col-span-3">Chưa có bài đăng nào.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Post Generation Modal -->
    <div id="post-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-2xl font-bold text-gray-800"><i class="fas fa-magic text-blue-500 mr-2"></i>AI Content & Image Generator</h3>
                <button id="close-post-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold">Thông tin bài đăng</h4>
                    <input type="hidden" id="post-plan-id">
                    <input type="text" id="post-title" placeholder="Tiêu đề / Ý tưởng chính" class="w-full p-3 border border-gray-300 rounded-lg">
                    <textarea id="post-keywords" placeholder="Từ khóa (AI sẽ dùng để viết bài và vẽ ảnh)" class="w-full p-3 border border-gray-300 rounded-lg h-24"></textarea>
                    <h4 class="text-lg font-semibold mt-4">Tùy chọn AI</h4>
                    <div>
                        <label class="font-medium">Số lượng ảnh cần tạo:</label>
                        <div class="flex items-center space-x-4 mt-2">
                            <label class="flex items-center"><input type="radio" name="image-count" value="1" class="mr-1" checked> 1</label>
                            <label class="flex items-center"><input type="radio" name="image-count" value="2" class="mr-1"> 2</label>
                            <label class="flex items-center"><input type="radio" name="image-count" value="3" class="mr-1"> 3</label>
                            <label class="flex items-center"><input type="radio" name="image-count" value="4" class="mr-1"> 4</label>
                        </div>
                    </div>
                    <button id="generate-content-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center text-lg">
                        <span id="generate-btn-text"><i class="fas fa-magic mr-2"></i>Bắt đầu Sáng tạo</span>
                        <div id="generate-loader" class="loader w-6 h-6 border-t-white hidden"></div>
                    </button>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">Kết quả</h4>
                    <div id="generation-result" class="mt-2 border rounded-lg p-4 bg-gray-50 min-h-[300px]">
                        <div id="result-placeholder" class="text-center text-gray-400 pt-10">
                            <i class="fas fa-wand-magic-sparkles text-4xl mb-3"></i>
                            <p>Nội dung và hình ảnh sẽ hiện ở đây.</p>
                        </div>
                        <div id="result-content" class="hidden">
                            <div id="generated-images-container" class="grid grid-cols-2 gap-2 mb-4"></div>
                            <textarea id="generated-text-area" class="w-full p-2 border rounded-md h-64"></textarea>
                        </div>
                    </div>
                    <button id="save-post-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition hidden">
                        <i class="fas fa-save mr-2"></i>Lưu Bài Đăng
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Post Modal -->
    <div id="edit-post-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-2xl font-bold text-gray-800"><i class="fas fa-edit text-purple-500 mr-2"></i>Chi Tiết & Chỉnh Sửa Bài Đăng</h3>
                <button id="close-edit-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-semibold">Nội dung</h4>
                    <input type="hidden" id="edit-post-id">
                    <input type="text" id="edit-post-title" placeholder="Tiêu đề" class="w-full p-3 border border-gray-300 rounded-lg mt-2">
                    <textarea id="edit-post-content" placeholder="Nội dung" class="w-full p-3 border border-gray-300 rounded-lg h-64 mt-4"></textarea>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">Hình ảnh</h4>
                    <div id="edit-post-images-container" class="grid grid-cols-2 gap-2 mt-2"></div>
                </div>
            </div>
            <div class="p-5 border-t flex justify-between items-center bg-gray-50 rounded-b-2xl">
                <button id="delete-post-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-trash mr-2"></i>Xóa
                </button>
                <div id="delete-confirm-container" class="hidden items-center">
                    <span class="text-red-600 mr-3">Bạn chắc chứ?</span>
                    <button id="confirm-delete-btn" class="bg-red-700 text-white py-1 px-3 rounded-md mr-2">Có, Xóa</button>
                    <button id="cancel-delete-btn" class="bg-gray-300 py-1 px-3 rounded-md">Hủy</button>
                </div>
                <button id="update-post-btn" class="bg-purple-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-save mr-2"></i>Lưu Thay Đổi
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, query, where, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase and App State ---
        let db, auth, userId, appId;
        let currentPlanId = null;
        let generatedPostData = null;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM Elements ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Planner
        const planForm = document.getElementById('plan-form');
        const planNameInput = document.getElementById('plan-name');
        const planKeywordsInput = document.getElementById('plan-keywords');
        const planList = document.getElementById('plan-list');
        const planDetailView = document.getElementById('plan-detail-view');

        // Calendar
        const postGrid = document.getElementById('post-grid');
        const showPostModalBtn = document.getElementById('show-post-modal-btn');

        // Create Modal
        const postModal = document.getElementById('post-modal');
        const closePostModalBtn = document.getElementById('close-post-modal-btn');
        const postPlanIdInput = document.getElementById('post-plan-id');
        const postTitleInput = document.getElementById('post-title');
        const postKeywordsInput = document.getElementById('post-keywords');
        const generateContentBtn = document.getElementById('generate-content-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateLoader = document.getElementById('generate-loader');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const resultContent = document.getElementById('result-content');
        const generatedImagesContainer = document.getElementById('generated-images-container');
        const generatedTextArea = document.getElementById('generated-text-area');
        const savePostBtn = document.getElementById('save-post-btn');
        
        // Edit Modal
        const editPostModal = document.getElementById('edit-post-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editPostIdInput = document.getElementById('edit-post-id');
        const editPostTitleInput = document.getElementById('edit-post-title');
        const editPostContentInput = document.getElementById('edit-post-content');
        const editPostImagesContainer = document.getElementById('edit-post-images-container');
        const updatePostBtn = document.getElementById('update-post-btn');
        const deletePostBtn = document.getElementById('delete-post-btn');
        const deleteConfirmContainer = document.getElementById('delete-confirm-container');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Message Box
        const messageBox = document.getElementById('message-box');

        // --- UI Functions ---
        function switchView(viewName) {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            navButtons.forEach(b => {
                b.classList.toggle('bg-blue-600', b.dataset.view === viewName);
                b.classList.toggle('text-white', b.dataset.view === viewName);
                b.classList.toggle('bg-gray-200', b.dataset.view !== viewName);
                b.classList.toggle('text-gray-700', b.dataset.view !== viewName);
            });
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 3000);
        }

        function openPostModal(plan = null) {
            postModal.classList.remove('hidden');
            postModal.classList.add('flex');
            generatedPostData = null;
            postPlanIdInput.value = plan ? plan.id : '';
            postTitleInput.value = '';
            postKeywordsInput.value = plan ? plan.data.keywords : '';
            resultPlaceholder.classList.remove('hidden');
            resultContent.classList.add('hidden');
            savePostBtn.classList.add('hidden');
            generatedTextArea.value = '';
            generatedImagesContainer.innerHTML = '';
        }

        function closePostModal() {
            postModal.classList.add('hidden');
            postModal.classList.remove('flex');
        }

        function openEditModal(post) {
            editPostIdInput.value = post.id;
            editPostTitleInput.value = post.data.title || '';
            editPostContentInput.value = post.data.content || '';
            editPostImagesContainer.innerHTML = '';
            if (post.data.images && post.data.images.length > 0) {
                post.data.images.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'existing-image rounded-lg';
                    editPostImagesContainer.appendChild(img);
                });
            } else {
                editPostImagesContainer.innerHTML = '<p class="text-gray-500 col-span-2">Không có hình ảnh cho bài đăng này.</p>';
            }
            deleteConfirmContainer.classList.add('hidden');
            deletePostBtn.classList.remove('hidden');
            editPostModal.classList.remove('hidden');
            editPostModal.classList.add('flex');
        }

        function closeEditModal() {
            editPostModal.classList.add('hidden');
            editPostModal.classList.remove('flex');
        }

        // --- Rendering Functions ---
        function createPostElement(post, clickHandler) {
            const postEl = document.createElement('div');
            postEl.className = 'bg-gray-50 p-3 rounded-lg border cursor-pointer hover:bg-gray-100 hover:border-gray-400 transition';
            postEl.innerHTML = `
                <p class="font-semibold">${post.data.title || 'Bài đăng chưa có tiêu đề'}</p>
                <p class="text-sm text-gray-600 truncate">${post.data.content}</p>
            `;
            postEl.addEventListener('click', () => clickHandler(post));
            return postEl;
        }

        function createPostCard(post, clickHandler) {
            const postCard = document.createElement('div');
            postCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col cursor-pointer hover:shadow-xl transition-shadow';
            let imageHtml = '<div class="h-48 bg-gray-200 flex items-center justify-center text-gray-400">Không có ảnh</div>';
            if (post.data.images && post.data.images.length > 0) {
               imageHtml = `<img src="${post.data.images[0]}" alt="Generated image" class="w-full h-48 object-cover">`;
            }
            postCard.innerHTML = `
                ${imageHtml}
                <div class="p-4 flex-grow flex flex-col">
                    <h4 class="font-bold text-lg mb-2">${post.data.title || 'Bài đăng'}</h4>
                    <p class="text-gray-600 text-sm flex-grow">${(post.data.content || '').substring(0, 100)}...</p>
                    <p class="text-xs text-gray-400 mt-3">Từ kế hoạch: ${post.data.planName || 'Bài đăng lẻ'}</p>
                </div>
            `;
            postCard.addEventListener('click', () => clickHandler(post));
            return postCard;
        }

        async function handlePostClick(post) {
            const postRef = doc(db, "artifacts", appId, "public", "data", "posts", post.id);
            const postSnap = await getDoc(postRef);
            if (postSnap.exists()) {
                openEditModal({ id: postSnap.id, data: postSnap.data() });
            } else {
                showMessage("Không tìm thấy bài đăng này.", "error");
            }
        }

        function renderPlans(plans) {
            planList.innerHTML = plans.length === 0 ? '<p class="text-gray-500">Chưa có kế hoạch nào. Hãy tạo một cái!</p>' : '';
            plans.forEach(plan => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer border ${currentPlanId === plan.id ? 'bg-blue-100 border-blue-400' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`;
                div.innerHTML = `<h4 class="font-bold text-gray-800">${plan.data.name}</h4><p class="text-sm text-gray-600 truncate">${plan.data.keywords}</p>`;
                div.addEventListener('click', () => {
                    currentPlanId = plan.id;
                    renderPlans(plans);
                    renderPlanDetail(plan);
                });
                planList.appendChild(div);
            });
        }

        async function renderPlanDetail(plan) {
            planDetailView.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-800">${plan.data.name}</h3>
                        <p class="text-gray-500 mt-1">Chủ đề: ${plan.data.keywords}</p>
                    </div>
                    <button id="generate-posts-for-plan-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-magic mr-2"></i>Tạo Bài Đăng
                    </button>
                </div>
                <hr class="my-4">
                <h4 class="text-xl font-bold mb-3 text-gray-700">Các bài đăng thuộc kế hoạch này</h4>
                <div id="plan-posts-list" class="space-y-3"></div>
            `;
            document.getElementById('generate-posts-for-plan-btn').addEventListener('click', () => openPostModal(plan));
            
            const postsCol = collection(db, "artifacts", appId, "public", "data", "posts");
            const q = query(postsCol, where("planId", "==", plan.id));
            onSnapshot(q, (snapshot) => {
                const posts = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                const listEl = document.getElementById('plan-posts-list');
                listEl.innerHTML = posts.length === 0 ? '<p class="text-gray-500">Chưa có bài đăng nào cho kế hoạch này.</p>' : '';
                posts.forEach(post => listEl.appendChild(createPostElement(post, handlePostClick)));
            });
        }
        
        function renderPosts(posts) {
            postGrid.innerHTML = posts.length === 0 ? '<p class="text-gray-500 md:col-span-2 xl:col-span-3 text-center py-10">Lịch của bạn đang trống. Hãy tạo bài đăng mới!</p>' : '';
            posts.forEach(post => postGrid.appendChild(createPostCard(post, handlePostClick)));
        }

        // --- AI Generation & Image Compression ---
        async function compressImage(base64Str, maxWidth = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
            });
        }

        async function generateText(prompt) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "AIzaSyCYpynULl6YpjHA29oO7-8wgdZfTA6jY_A";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Text generation failed: ${response.status}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
            throw new Error("Text generation failed: Invalid response format.");
        }

        async function generateImages(prompt, count) {
            const imagePromises = [];
            for (let i = 0; i < count; i++) {
                const payload = {
                  contents: [{ parts: [{ text: `${prompt}, cinematic style, high quality marketing photo` }] }],
                  generationConfig: { responseModalities: ['IMAGE', 'TEXT'] },
                };
                const apiKey = "AIzaSyCYpynULl6YpjHA29oO7-8wgdZfTA6jY_A";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${apiKey}`;
                const promise = fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                    .then(res => res.ok ? res.json() : Promise.reject(new Error(`Image generation failed: ${res.status}`)))
                    .then(result => {
                        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) return `data:image/png;base64,${base64Data}`;
                        throw new Error("Image generation failed: No image data.");
                    });
                imagePromises.push(promise);
            }
            return Promise.all(imagePromises);
        }

        async function handleGenerateContent() {
            const keywords = postKeywordsInput.value.trim();
            if (!keywords) {
                showMessage("Vui lòng nhập từ khóa để AI sáng tạo.", 'error');
                return;
            }
            generateBtnText.classList.add('hidden');
            generateLoader.classList.remove('hidden');
            generateContentBtn.disabled = true;
            resultPlaceholder.classList.add('hidden');
            resultContent.classList.add('hidden');
            try {
                const title = postTitleInput.value.trim();
                const imageCount = parseInt(document.querySelector('input[name="image-count"]:checked').value);
                const textPrompt = `Viết một bài đăng mạng xã hội bằng tiếng Việt. Chủ đề: ${title || keywords}. Từ khóa chính: ${keywords}. Yêu cầu: Hấp dẫn, có emoji, kêu gọi hành động, và có hashtags.`;
                const imagePrompt = `A visually stunning marketing image about "${keywords}", high quality, professional photography.`;
                const [textContent, imageUrls] = await Promise.all([generateText(textPrompt), generateImages(imagePrompt, imageCount)]);
                generatedPostData = { content: textContent, images: imageUrls };
                generatedTextArea.value = textContent;
                generatedImagesContainer.innerHTML = '';
                imageUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'generated-image rounded-lg';
                    generatedImagesContainer.appendChild(img);
                });
                resultContent.classList.remove('hidden');
                savePostBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Generation Error:", error);
                showMessage(`Lỗi sáng tạo: ${error.message}`, 'error');
                resultPlaceholder.classList.remove('hidden');
            } finally {
                generateBtnText.classList.remove('hidden');
                generateLoader.classList.add('hidden');
                generateContentBtn.disabled = false;
            }
        }

        // --- Firestore Logic ---
        async function setupFirebase() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    attachFirestoreListeners();
                }
            });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdDisplay.textContent = "Lỗi xác thực";
            }
        }

        function attachFirestoreListeners() {
            if (!userId) return;
            const plansQuery = query(collection(db, "artifacts", appId, "public", "data", "plans"), where("userId", "==", userId));
            onSnapshot(plansQuery, (snapshot) => renderPlans(snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }))));
            const postsQuery = query(collection(db, "artifacts", appId, "public", "data", "posts"), where("userId", "==", userId));
            onSnapshot(postsQuery, (snapshot) => renderPosts(snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }))));
        }

        async function handleAddPlan(e) {
            e.preventDefault();
            const name = planNameInput.value.trim();
            const keywords = planKeywordsInput.value.trim();
            if (!name || !keywords || !userId) return;
            try {
                await addDoc(collection(db, "artifacts", appId, "public", "data", "plans"), { name, keywords, userId, createdAt: new Date() });
                showMessage("Đã tạo kế hoạch thành công!");
                planForm.reset();
            } catch (error) {
                console.error("Error adding plan:", error);
                showMessage("Lỗi khi tạo kế hoạch.", 'error');
            }
        }

        async function handleSavePost() {
            if (!generatedPostData || !userId) return;
            const planId = postPlanIdInput.value;
            let planName = 'Bài đăng lẻ';
            if (planId) {
                const planSnap = await getDoc(doc(db, "artifacts", appId, "public", "data", "plans", planId));
                if (planSnap.exists()) planName = planSnap.data().name;
            }
            try {
                const compressedImages = await Promise.all(generatedPostData.images.map(imgBase64 => compressImage(imgBase64)));
                await addDoc(collection(db, "artifacts", appId, "public", "data", "posts"), {
                    title: postTitleInput.value.trim() || 'Bài đăng chưa có tiêu đề',
                    keywords: postKeywordsInput.value.trim(),
                    content: generatedPostData.content,
                    images: compressedImages,
                    planId: planId || null,
                    planName: planName,
                    userId,
                    createdAt: new Date()
                });
                showMessage("Đã lưu bài đăng thành công!");
                closePostModal();
            } catch (error) {
                console.error("Error saving post:", error);
                showMessage(error.message.includes("1048487") ? "Lỗi: Kích thước hình ảnh quá lớn." : "Lỗi khi lưu bài đăng.", 'error');
            }
        }

        async function handleUpdatePost() {
            const postId = editPostIdInput.value;
            if (!postId) return;
            const postRef = doc(db, "artifacts", appId, "public", "data", "posts", postId);
            try {
                await updateDoc(postRef, {
                    title: editPostTitleInput.value.trim(),
                    content: editPostContentInput.value.trim()
                });
                showMessage("Đã cập nhật bài đăng!");
                closeEditModal();
            } catch (error) {
                console.error("Error updating post:", error);
                showMessage("Lỗi khi cập nhật.", "error");
            }
        }

        async function handleDeletePost() {
            const postId = editPostIdInput.value;
            if (!postId) return;
            const postRef = doc(db, "artifacts", appId, "public", "data", "posts", postId);
            try {
                await deleteDoc(postRef);
                showMessage("Đã xóa bài đăng.");
                closeEditModal();
            } catch (error) {
                console.error("Error deleting post:", error);
                showMessage("Lỗi khi xóa.", "error");
            }
        }

        // --- Event Listeners ---
        navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        planForm.addEventListener('submit', handleAddPlan);
        showPostModalBtn.addEventListener('click', () => openPostModal());
        closePostModalBtn.addEventListener('click', closePostModal);
        generateContentBtn.addEventListener('click', handleGenerateContent);
        savePostBtn.addEventListener('click', handleSavePost);

        // Edit Modal Listeners
        closeEditModalBtn.addEventListener('click', closeEditModal);
        updatePostBtn.addEventListener('click', handleUpdatePost);
        deletePostBtn.addEventListener('click', () => {
            deletePostBtn.classList.add('hidden');
            deleteConfirmContainer.classList.remove('hidden');
        });
        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmContainer.classList.add('hidden');
            deletePostBtn.classList.remove('hidden');
        });
        confirmDeleteBtn.addEventListener('click', handleDeletePost);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', setupFirebase);

    </script>
</body>
</html>
